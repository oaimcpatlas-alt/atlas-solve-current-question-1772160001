name: FixedPasswordProbe

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/fixed_password_probe.yml'

permissions:
  contents: write

jobs:
  run:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Probe account verify with fixed password
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const PASSWORD = "AtlasFixed!24680Aa";
          const USERNAME = 'oaimcpatlas@gmail.com';

          function write(obj) {
            fs.writeFileSync('fixed_password_probe_result.json', JSON.stringify(obj, null, 2));
          }

          function buildAccountCookieHeader() {
            try {
              const raw = JSON.parse(fs.readFileSync('browser_cookies.json', 'utf8'));
              const cookies = Array.isArray(raw.cookies) ? raw.cookies : [];
              const allowed = new Set(['account.mongodb.com', '.account.mongodb.com', '.mongodb.com']);
              const keepNames = new Set([
                'remember-user-device',
                'user-device',
                '__Secure-mdb-sat',
                '__Secure-mdb-srt',
                'accounta-prod',
                'okta-oauth-state',
                'okta-oauth-nonce',
                'oidc-init-user-prod'
              ]);
              const parts = [];
              for (const c of cookies) {
                const domain = String(c.domain || '');
                const name = String(c.name || '');
                const value = typeof c.value === 'string' ? c.value : '';
                if (allowed.has(domain) && keepNames.has(name) && value) {
                  parts.push(`${name}=${value}`);
                }
              }
              return parts.join('; ');
            } catch {
              return '';
            }
          }

          async function main() {
            const result = { started_at: new Date().toISOString(), password: PASSWORD };
            try {
              const cookieHeader = buildAccountCookieHeader();
              result.cookieHeaderLength = cookieHeader.length;
              const resp = await fetch('https://account.mongodb.com/account/auth/verify', {
                method: 'POST',
                redirect: 'manual',
                headers: {
                  'User-Agent': 'Mozilla/5.0',
                  'Content-Type': 'application/json',
                  'Accept': 'application/json',
                  'Cookie': cookieHeader,
                },
                body: JSON.stringify({ username: USERNAME, password: PASSWORD }),
              });
              const text = await resp.text();
              let json = null;
              try { json = JSON.parse(text); } catch {}
              result.verify = {
                status: resp.status,
                headers: Object.fromEntries(resp.headers.entries()),
                body: text,
                json,
              };
              const lr = json && json.loginRedirect;
              if (lr) {
                result.loginRedirect = lr;
                const follow = await fetch(new URL(lr, 'https://account.mongodb.com').toString(), {
                  method: 'GET',
                  redirect: 'manual',
                  headers: {
                    'User-Agent': 'Mozilla/5.0',
                    'Cookie': cookieHeader,
                  },
                });
                result.followLoginRedirect = {
                  status: follow.status,
                  headers: Object.fromEntries(follow.headers.entries()),
                  bodyHead: (await follow.text()).slice(0, 1000),
                };
              }
            } catch (e) {
              result.error = String(e && e.message || e);
              result.stack = e && e.stack || null;
            } finally {
              result.finished_at = new Date().toISOString();
              write(result);
            }
          }

          main();
          NODE
      - if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add fixed_password_probe_result.json
          if git diff --cached --quiet; then
            echo "No result changes"
            exit 0
          fi
          git commit -m "Write fixed password probe result"
          git push origin HEAD:main
