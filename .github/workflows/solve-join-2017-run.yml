name: SolveJoin2017Run
on:
  push:
    branches: [join2017run-1772243938]
jobs:
  solve:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          npm install ws mongodb
      - name: Authenticate and capture cloud cookies
        shell: bash
        run: |
          python scripts/solve_join_auth.py
          test -f auth_debug.json && cat auth_debug.json | head -c 30000 || true
      - name: Query via Atlas browser proxy
        shell: bash
        run: |
          export CLOUD_COOKIES="$(cat cloud_cookie_header.txt 2>/dev/null || true)"
          if [ -z "$CLOUD_COOKIES" ]; then
            echo '{"error":"no cloud cookies"}' > query_result.json
          else
            node query_join_proxy.js > query_result.json || true
          fi
          cat query_result.json
      - name: Summarize result
        shell: bash
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          out = {}
          for name in ['auth_debug.json','query_result.json']:
              try:
                  out[name] = json.loads(Path(name).read_text(encoding='utf-8'))
              except Exception as e:
                  try:
                      out[name] = Path(name).read_text(encoding='utf-8')[:4000]
                  except Exception:
                      out[name] = f'ERR: {e}'
          Path('final_status.json').write_text(json.dumps(out, indent=2), encoding='utf-8')
          print(json.dumps(out, indent=2))
          PY
      - name: Commit outputs
        if: always()
        shell: bash
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .github/workflows/solve-join-2017-run.yml scripts/solve_join_auth.py query_join_proxy.js trigger.txt auth_debug.json cloud_cookie_header.txt query_result.json final_status.json
          git commit -m "workflow result" || exit 0
          for i in 1 2 3 4 5; do
            git pull --rebase origin join2017run-1772243938 && git push origin HEAD:join2017run-1772243938 && exit 0 || true
            sleep 10
          done
          exit 0
