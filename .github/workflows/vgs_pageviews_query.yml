name: VGSPageviewsQuery

on:
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/vgs_pageviews_query.yml'

permissions:
  contents: write

jobs:
  run:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 25
    env:
      MONGO_URI: "mongodb+srv://oaimcpatlas_db_user:pdVEIpUnn0quf2Mr@mcpatlas.zlknsyp.mongodb.net"
      GROUP_URL: "https://cloud.mongodb.com/v2/699c12be8df98bd863d63d70#/overview"
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pymongo playwright
          python -m playwright install --with-deps chromium

      - name: Whitelist current IP with stored cookies and query DB
        run: |
          python - <<'PY'
          import json, os, time, traceback
          from pymongo import MongoClient
          from playwright.sync_api import sync_playwright

          result = {"browser": {}, "connect_attempts": []}

          def norm_cookie(c):
              out = {
                  "name": c.get("name", ""),
                  "value": c.get("value", ""),
                  "domain": c.get("domain", ""),
                  "path": c.get("path", "/"),
                  "httpOnly": bool(c.get("httpOnly", False)),
                  "secure": bool(c.get("secure", True)),
              }
              if "expires" in c and c["expires"] is not None:
                  try:
                      out["expires"] = int(c["expires"])
                  except Exception:
                      pass
              ss = c.get("sameSite")
              if ss in ("Lax", "None", "Strict"):
                  out["sameSite"] = ss
              return out

          try:
              raw = json.load(open("browser_cookies.json", "r", encoding="utf-8"))
              cookies = [norm_cookie(c) for c in raw.get("cookies", []) if c.get("name") and c.get("value")]
              result["browser"]["cookie_count_loaded"] = len(cookies)
              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context()
                  if cookies:
                      context.add_cookies(cookies)
                  page = context.new_page()
                  clicked = []
                  page.goto(os.environ["GROUP_URL"], wait_until="domcontentloaded", timeout=120000)
                  page.wait_for_timeout(12000)
                  for label in [
                      "Skip personalization", "Skip for now", "Got it", "Dismiss", "Close",
                      "Add Current IP Address", "Allow Access From Current IP Address",
                      "Add Current IP", "Add IP Address", "Allow Access", "Confirm", "Save", "Add"
                  ]:
                      try:
                          loc = page.get_by_text(label, exact=True)
                          if loc.first.is_visible(timeout=3000):
                              loc.first.click()
                              clicked.append(label)
                              page.wait_for_timeout(6000)
                      except Exception:
                          pass
                  page.wait_for_timeout(12000)
                  result["browser"]["clicked"] = clicked
                  result["browser"]["final_url"] = page.url
                  try:
                      result["browser"]["title"] = page.title()
                  except Exception:
                      pass
                  try:
                      result["browser"]["excerpt"] = page.locator('body').inner_text(timeout=5000)[:4000]
                  except Exception:
                      pass
                  fresh = context.cookies()
                  json.dump({"start_url": os.environ["GROUP_URL"], "cookies": fresh}, open("browser_cookies.json", "w", encoding="utf-8"), indent=2)
                  result["browser"]["final_cookie_count"] = len(fresh)
                  browser.close()
          except Exception as e:
              result["browser"]["error"] = str(e)
              result["browser"]["traceback"] = traceback.format_exc()

          client = None
          last_error = None
          for attempt in range(1, 11):
              try:
                  client = MongoClient(os.environ["MONGO_URI"], serverSelectionTimeoutMS=20000, connectTimeoutMS=20000, socketTimeoutMS=20000)
                  result["ping"] = client.admin.command("ping")
                  result["connected_on_attempt"] = attempt
                  break
              except Exception as e:
                  last_error = repr(e)
                  result["connect_attempts"].append({"attempt": attempt, "error": last_error})
                  time.sleep(10)

          if client is None:
              result["error"] = f"connect failed: {last_error}"
          else:
              try:
                  col = client["video_game_store"]["Digital Analytics"]
                  result["estimated_count"] = col.estimated_document_count()

                  pipeline_total = [
                      {"$group": {
                          "_id": "$Date",
                          "totalPageViews": {"$sum": "$Page Views"},
                          "totalUniqueVisitors": {"$sum": "$Unique Visitors"},
                          "maxSingleRecordPageViews": {"$max": "$Page Views"},
                          "records": {"$sum": 1}
                      }},
                      {"$sort": {"totalPageViews": -1, "_id": 1}},
                      {"$limit": 10}
                  ]
                  result["top_dates_by_total_page_views"] = list(col.aggregate(pipeline_total))

                  pipeline_single = [
                      {"$sort": {"Page Views": -1, "Date": 1}},
                      {"$limit": 10}
                  ]
                  def ser(v):
                      t = type(v).__name__
                      if t == "ObjectId":
                          return str(v)
                      if isinstance(v, (str, int, float, bool)) or v is None:
                          return v
                      if hasattr(v, "isoformat"):
                          try:
                              return v.isoformat()
                          except Exception:
                              return str(v)
                      if isinstance(v, list):
                          return [ser(x) for x in v]
                      if isinstance(v, dict):
                          return {str(k): ser(vv) for k, vv in v.items()}
                      return str(v)
                  result["top_single_records_by_page_views"] = [ser(x) for x in col.aggregate(pipeline_single)]

                  if result["top_dates_by_total_page_views"]:
                      top = result["top_dates_by_total_page_views"][0]
                      result["best_date_by_total_page_views"] = ser(top["_id"])
                  if result["top_single_records_by_page_views"]:
                      top1 = result["top_single_records_by_page_views"][0]
                      result["best_single_record_date"] = top1.get("Date")
              except Exception as e:
                  result["query_error"] = repr(e)
                  result["query_traceback"] = traceback.format_exc()
              finally:
                  try:
                      client.close()
                  except Exception:
                      pass

          json.dump(result, open("vg_pageviews_result.json", "w", encoding="utf-8"), indent=2)
          PY

      - if: always()
        name: Commit result
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add vg_pageviews_result.json browser_cookies.json
          if git diff --cached --quiet; then
            echo "No result changes"
            exit 0
          fi
          git commit -m "Write VGS pageviews result"
          git push origin HEAD:main
