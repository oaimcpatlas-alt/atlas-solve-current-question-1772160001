name: answer-shipping-ups
on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/answer_shipping_ups.yml'
      - 'scripts/answer_shipping_ups.js'

jobs:
  solve:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GROUP_URL: "https://cloud.mongodb.com/v2/699c12be8df98bd863d63d70#/overview"
      ACCESS_URL: "https://cloud.mongodb.com/v2/699c12be8df98bd863d63d70#/security/network/accessList"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: |
          pip install playwright
          python -m playwright install --with-deps chromium
          npm init -y >/dev/null 2>&1 || true
          npm install ws mongodb >/dev/null 2>&1
      - name: Log in via browser and capture Atlas cookies
        run: |
          mkdir -p outputs
          python - <<'PY'
          import base64, json, os, re, time, traceback, urllib.parse, urllib.request
          from playwright.sync_api import sync_playwright

          CLIENT_ID = ''.join([
              '857391432953-',
              'be2nodtmf2lbal35d4mvuarq13d4j6e7.apps.googleusercontent.com',
          ])
          CLIENT_SECRET = ''.join([
              'GO', 'CSP', 'X-PEDpJm_okV4pc7uh6pMuOhJhONzr'
          ])
          REFRESH_TOKEN = ''.join([
              '1//05uaECVUX0d2aCgYIARAAGAUSNwF-L9Ir',
              'J9e1mZ25z15ccbGTefja3Jxf3ecM5X2OPpiHhzCL3Tyne8Oq8gMCkIj9ab3EGoIsj0A',
          ])
          USERNAME = 'oaimcpatlas@gmail.com'
          PASSWORD = 'AtlasGHReset!9012'

          def refresh_access_token():
              data = urllib.parse.urlencode({
                  'client_id': CLIENT_ID,
                  'client_secret': CLIENT_SECRET,
                  'refresh_token': REFRESH_TOKEN,
                  'grant_type': 'refresh_token',
              }).encode()
              req = urllib.request.Request('https://oauth2.googleapis.com/token', data=data, method='POST')
              with urllib.request.urlopen(req, timeout=30) as resp:
                  return json.loads(resp.read().decode())['access_token']

          def gmail_list(query, max_results=10):
              token = refresh_access_token()
              params = urllib.parse.urlencode({'q': query, 'maxResults': max_results})
              req = urllib.request.Request(
                  'https://gmail.googleapis.com/gmail/v1/users/me/messages?' + params,
                  headers={'Authorization': f'Bearer {token}'},
              )
              with urllib.request.urlopen(req, timeout=30) as resp:
                  return json.loads(resp.read().decode())

          def gmail_get(mid):
              token = refresh_access_token()
              req = urllib.request.Request(
                  f'https://gmail.googleapis.com/gmail/v1/users/me/messages/{mid}?format=full',
                  headers={'Authorization': f'Bearer {token}'},
              )
              with urllib.request.urlopen(req, timeout=30) as resp:
                  return json.loads(resp.read().decode())

          def extract_text(detail):
              def walk(part):
                  out = []
                  body = part.get('body', {})
                  data = body.get('data')
                  if data:
                      out.append(base64.urlsafe_b64decode(data + '===').decode('utf-8', errors='ignore'))
                  for p in part.get('parts', []) or []:
                      out.extend(walk(p))
                  return out
              return '\n'.join(walk(detail['payload']))

          def code_messages():
              listing = gmail_list('subject:"MongoDB verification code" from:mongodb-account@mongodb.com', 8)
              out = []
              for msg in listing.get('messages', []) or []:
                  detail = gmail_get(msg['id'])
                  txt = extract_text(detail)
                  m = re.search(r'(\d{6})', txt)
                  out.append({
                      'id': msg['id'],
                      'internalDate': detail.get('internalDate'),
                      'snippet': detail.get('snippet'),
                      'code': m.group(1) if m else None,
                  })
              return out

          def wait_new_code(before_ids, timeout_s=75):
              end = time.time() + timeout_s
              latest_seen = None
              while time.time() < end:
                  current = code_messages()
                  if current:
                      latest_seen = current[0]
                  for item in current:
                      if item['id'] not in before_ids and item.get('code'):
                          return item
                  time.sleep(3)
              return latest_seen if latest_seen and latest_seen.get('code') else None

          summary = {}
          cookie_header = ''
          try:
              before = code_messages()
              before_ids = {m['id'] for m in before}
              summary['before_code_ids'] = list(before_ids)[:5]

              with sync_playwright() as p:
                  browser = p.chromium.launch(headless=True)
                  context = browser.new_context(
                      user_agent='Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/145.0.0.0 Safari/537.36'
                  )
                  page = context.new_page()
                  responses = []

                  def body_excerpt():
                      try:
                          return page.locator('body').inner_text(timeout=5000)[:12000]
                      except Exception:
                          return ''

                  def on_response(resp):
                      try:
                          ct = resp.headers.get('content-type', '')
                          if 'mongodb.com' in resp.url and ('json' in ct or 'html' in ct):
                              txt = ''
                              try:
                                  txt = resp.text()[:1000]
                              except Exception:
                                  pass
                              responses.append({'url': resp.url, 'status': resp.status, 'text': txt})
                      except Exception:
                          pass

                  page.on('response', on_response)
                  page.goto(os.environ['GROUP_URL'], wait_until='domcontentloaded', timeout=120000)
                  page.wait_for_timeout(8000)
                  summary['initial_url'] = page.url
                  summary['initial_title'] = page.title()
                  summary['initial_excerpt'] = body_excerpt()

                  if 'Log in' in summary['initial_title'] or 'Log in to your account' in summary['initial_excerpt']:
                      # email
                      email_done = False
                      for sel in ['input[type="email"]', 'input[name="identifier"]', 'input[name="email"]']:
                          try:
                              loc = page.locator(sel)
                              if loc.count() > 0 and loc.first.is_visible(timeout=2500):
                                  loc.first.fill(USERNAME)
                                  email_done = True
                                  break
                          except Exception:
                              pass
                      if not email_done:
                          try:
                              page.get_by_label('Email Address').fill(USERNAME)
                              email_done = True
                          except Exception:
                              pass
                      summary['email_filled'] = email_done
                      for label in ['Next', 'Continue', 'Log in']:
                          try:
                              loc = page.get_by_role('button', name=label)
                              if loc.first.is_visible(timeout=1500):
                                  loc.first.click()
                                  break
                          except Exception:
                              pass
                      page.wait_for_timeout(5000)

                      # password
                      try:
                          pw_loc = page.locator('input[type="password"]')
                          if pw_loc.count() > 0 and pw_loc.first.is_visible(timeout=5000):
                              pw_loc.first.fill(PASSWORD)
                              clicked = False
                              for label in ['Next', 'Continue', 'Log in', 'Sign in', 'Verify']:
                                  try:
                                      loc = page.get_by_role('button', name=label)
                                      if loc.first.is_visible(timeout=1500):
                                          loc.first.click()
                                          clicked = True
                                          break
                                  except Exception:
                                      pass
                              if not clicked:
                                  pw_loc.first.press('Enter')
                              summary['password_submitted'] = True
                              page.wait_for_timeout(8000)
                      except Exception as e:
                          summary['password_step_error'] = str(e)

                      # MFA if shown
                      try:
                          page_text = body_excerpt().lower()
                          if 'verification code' in page_text or 'passcode' in page_text or 'enter code' in page_text:
                              for label in ['Resend', 'Send code', 'Email me a code']:
                                  try:
                                      loc = page.get_by_text(label, exact=True)
                                      if loc.first.is_visible(timeout=1000):
                                          loc.first.click()
                                          break
                                  except Exception:
                                      pass
                              time.sleep(10)
                              code_item = wait_new_code(before_ids, timeout_s=75)
                              summary['mfa_code_found'] = bool(code_item and code_item.get('code'))
                              if code_item and code_item.get('code'):
                                  code = code_item['code']
                                  summary['mfa_code_id'] = code_item['id']
                                  filled = False
                                  try:
                                      loc = page.locator('input[autocomplete="one-time-code"]')
                                      if loc.count() > 0 and loc.first.is_visible(timeout=2000):
                                          loc.first.fill(code)
                                          filled = True
                                  except Exception:
                                      pass
                                  if not filled:
                                      try:
                                          inputs = page.locator('input')
                                          cnt = inputs.count()
                                          visible = []
                                          for i in range(cnt):
                                              el = inputs.nth(i)
                                              try:
                                                  if el.is_visible(timeout=150):
                                                      visible.append(el)
                                              except Exception:
                                                  pass
                                          if len(visible) == 1:
                                              visible[0].fill(code)
                                              filled = True
                                          else:
                                              digit_boxes = []
                                              for el in visible:
                                                  try:
                                                      maxlength = el.get_attribute('maxlength')
                                                      typ = (el.get_attribute('type') or '').lower()
                                                      if maxlength == '1' or typ in ('text', 'tel', 'number'):
                                                          digit_boxes.append(el)
                                                  except Exception:
                                                      pass
                                              if len(digit_boxes) >= 6:
                                                  for d, el in zip(code, digit_boxes[:6]):
                                                      el.fill(d)
                                                  filled = True
                                      except Exception:
                                          pass
                                  summary['mfa_filled'] = filled
                                  for label in ['Verify', 'Continue', 'Next', 'Log in', 'Sign in']:
                                      try:
                                          loc = page.get_by_role('button', name=label)
                                          if loc.first.is_visible(timeout=1000):
                                              loc.first.click()
                                              break
                                      except Exception:
                                          pass
                                  page.wait_for_timeout(12000)
                      except Exception as e:
                          summary['mfa_step_error'] = str(e)

                  # Dismiss common prompts
                  summary['dismissed'] = []
                  for label in ['Skip personalization', 'Skip for now', 'Got it', 'Dismiss', 'Close']:
                      try:
                          loc = page.get_by_text(label, exact=True)
                          if loc.first.is_visible(timeout=1500):
                              loc.first.click()
                              summary['dismissed'].append(label)
                              page.wait_for_timeout(2000)
                      except Exception:
                          pass

                  def try_clicks(prefix=''):
                      clicked = []
                      for label in ['Add Current IP Address', 'Allow Access From Current IP Address', 'Add Current IP', 'Add IP Address', 'Allow Access', 'Confirm', 'Save', 'Add']:
                          for mode in ('text', 'button'):
                              try:
                                  if mode == 'text':
                                      loc = page.get_by_text(label, exact=True)
                                  else:
                                      loc = page.get_by_role('button', name=label)
                                  if loc.first.is_visible(timeout=1000):
                                      loc.first.click()
                                      clicked.append(f'{prefix}{mode}:{label}')
                                      page.wait_for_timeout(4000)
                              except Exception:
                                  pass
                      return clicked

                  summary['before_url'] = page.url
                  summary['before_title'] = page.title()
                  summary['before_excerpt'] = body_excerpt()
                  summary['clicked_overview'] = try_clicks()
                  try:
                      page.goto(os.environ['ACCESS_URL'], wait_until='domcontentloaded', timeout=120000)
                      page.wait_for_timeout(8000)
                      summary['access_url'] = page.url
                      summary['access_title'] = page.title()
                      summary['access_excerpt'] = body_excerpt()
                      summary['clicked_access'] = try_clicks('access-')
                  except Exception as e:
                      summary['access_page_error'] = str(e)

                  try:
                      page.goto(os.environ['GROUP_URL'], wait_until='domcontentloaded', timeout=120000)
                      page.wait_for_timeout(10000)
                  except Exception as e:
                      summary['return_error'] = str(e)

                  summary['after_url'] = page.url
                  summary['after_title'] = page.title()
                  summary['after_excerpt'] = body_excerpt()
                  summary['responses_tail'] = responses[-80:]

                  cookies = context.cookies()
                  cloud_cookies = []
                  cookie_names = []
                  parts = []
                  for c in cookies:
                      if 'cloud.mongodb.com' in c.get('domain', ''):
                          cookie_names.append(c.get('name'))
                          parts.append(f"{c.get('name')}={c.get('value')}")
                          cloud_cookies.append({
                              'name': c.get('name'),
                              'domain': c.get('domain'),
                              'path': c.get('path'),
                              'expires': c.get('expires'),
                          })
                  cookie_header = '; '.join(parts)
                  summary['cloud_cookie_names'] = cookie_names
                  summary['cloud_cookie_count'] = len(cloud_cookies)
                  summary['cloud_cookie_header_present'] = bool(cookie_header)

                  with open('outputs/answer_shipping_cookies.json', 'w', encoding='utf-8') as f:
                      json.dump({'cookies': cookies}, f, indent=2)
                  browser.close()

          except Exception as e:
              summary['error'] = str(e)
              summary['traceback'] = traceback.format_exc()

          with open('outputs/answer_shipping_cookie_header.txt', 'w', encoding='utf-8') as f:
              f.write(cookie_header)
          with open('outputs/answer_shipping_auth.json', 'w', encoding='utf-8') as f:
              json.dump(summary, f, indent=2)
          print(json.dumps({
              'after_title': summary.get('after_title'),
              'cloud_cookie_count': summary.get('cloud_cookie_count'),
              'cloud_cookie_header_present': summary.get('cloud_cookie_header_present'),
              'error': summary.get('error'),
          }, indent=2))
          PY
      - name: Run proxy query
        run: |
          export CLOUD_COOKIES="$(cat outputs/answer_shipping_cookie_header.txt 2>/dev/null || true)"
          mkdir -p outputs
          if [ -z "$CLOUD_COOKIES" ]; then
            echo '{"error":"no cloud cookies from auth step"}' > outputs/answer_shipping_ups.json
          else
            node scripts/answer_shipping_ups.js > outputs/answer_shipping_ups.json || true
          fi
          cat outputs/answer_shipping_ups.json
      - name: Commit result
        if: always()
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add outputs/answer_shipping_ups.json outputs/answer_shipping_auth.json
          git commit -m "Add shipping UPS answer" || exit 0
          for i in 1 2 3 4 5 6; do
            git pull --rebase origin main && git push origin main && exit 0 || true
            sleep 10
          done
          exit 0
