
name: EPCSocialViewsFast
on:
  push:
    branches: [epc-social-views-fast-1772234013]
permissions:
  contents: write
jobs:
  query:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install dependencies
        run: python -m pip install --disable-pip-version-check -q pymongo dnspython
      - name: Query October 2023 top-view social post
        run: |
          python - <<'PY'
          import json, time, os
          from datetime import datetime, timezone
          from pymongo import MongoClient
          import dns.resolver

          USER="oaimcpatlas_db_user"
          PASSWORD="pdVEIpUnn0quf2Mr"
          ROOT="mcpatlas.zlknsyp.mongodb.net"
          def parse_date(v):
              if isinstance(v, datetime):
                  return v if v.tzinfo else v.replace(tzinfo=timezone.utc)
              if v is None: return None
              s=str(v).strip()
              if not s: return None
              for cand in [s, s.replace(" ","T"), s.replace("Z","+00:00"), s.replace(" ","T").replace("Z","+00:00")]:
                  try:
                      dt=datetime.fromisoformat(cand)
                      return dt if dt.tzinfo else dt.replace(tzinfo=timezone.utc)
                  except Exception: pass
              for fmt in ["%Y-%m-%d","%Y/%m/%d","%m/%d/%Y","%d/%m/%Y","%d-%m-%Y","%Y-%m-%d %H:%M:%S","%Y/%m/%d %H:%M:%S"]:
                  try:
                      sample=datetime.now().strftime(fmt)
                      return datetime.strptime(s[:len(sample)], fmt).replace(tzinfo=timezone.utc)
                  except Exception: pass
              return None
          def parse_num(v):
              if isinstance(v,(int,float)) and not isinstance(v,bool): return float(v)
              if v is None: return None
              s=str(v).strip().replace(',','')
              try: return float(s)
              except Exception: return None
          def ser(v):
              if isinstance(v, datetime): return v.isoformat()
              if type(v).__name__=='ObjectId': return str(v)
              if isinstance(v, list): return [ser(x) for x in v[:20]]
              if isinstance(v, dict): return {str(k): ser(vv) for k,vv in list(v.items())[:100]}
              return v
          hosts=[]
          try:
              hosts=[str(r.target).rstrip('.') for r in dns.resolver.resolve(f"_mongodb._tcp.{ROOT}","SRV")]
          except Exception:
              pass
          for h in ["ac-lxbrbla-shard-00-00.zlknsyp.mongodb.net","ac-lxbrbla-shard-00-01.zlknsyp.mongodb.net","ac-lxbrbla-shard-00-02.zlknsyp.mongodb.net"]:
              if h not in hosts: hosts.append(h)
          seed=",".join(f"{h}:27017" for h in hosts)
          uris=[
              ("srv", f"mongodb+srv://{USER}:{PASSWORD}@{ROOT}/?retryWrites=false"),
              ("seed", f"mongodb://{USER}:{PASSWORD}@{seed}/?tls=true&authSource=admin&replicaSet=atlas-pq8tl1-shard-0&readPreference=secondaryPreferred&retryWrites=false"),
          ]
          out={"runner_os": os.environ.get("RUNNER_OS"), "attempts":[], "resolved_hosts":hosts}
          client=None
          for label, uri in uris:
              try:
                  c=MongoClient(uri, serverSelectionTimeoutMS=12000, connectTimeoutMS=12000, socketTimeoutMS=12000)
                  out["ping"]=c.admin.command("ping")
                  out["used_connection"]=label
                  client=c
                  break
              except Exception as e:
                  out["attempts"].append({"uri_label":label,"error":repr(e)[:2000]})
          if client is None:
              out["error"]="no connection"
          else:
              docs=list(client["video_game_store"]["Social Media"].find({}, {"_id":0}))
              filt=[]
              for d in docs:
                  dt=parse_date(d.get("Date")); views=parse_num(d.get("Views"))
                  if dt and views is not None and dt.year==2023 and dt.month==10:
                      dd=dict(d); dd["_parsedDate"]=dt.isoformat(); dd["_views"]=views; filt.append(dd)
              filt.sort(key=lambda d:(d["_views"], d.get("Likes",0), str(d.get("Post ID",""))), reverse=True)
              out["matching_count"]=len(filt)
              out["answer"]=ser(filt[0]) if filt else None
              out["top5"]=[ser(x) for x in filt[:5]]
          os.makedirs("outputs", exist_ok=True)
          with open(f"outputs/epc_social_views_fast_{os.environ.get('RUNNER_OS','runner')}.json","w") as f:
              json.dump(out,f,indent=2,default=ser)
          print(json.dumps(out, default=ser))
          PY
      - name: Commit result
        if: always()
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add outputs/epc_social_views_fast_*.json .github/workflows/epc_social_views_fast.yml
          git commit -m "Write fast EPC social views result on ${{ matrix.os }}" || exit 0
          git pull --rebase origin epc-social-views-fast-1772234013 || true
          git push origin epc-social-views-fast-1772234013 || true
