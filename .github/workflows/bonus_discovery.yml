
name: BonusDiscovery
on:
  push:
    branches: [bonus-discovery-1772426500]
    paths-ignore:
      - 'bonus_discovery_result.json'
      - 'auth_bonus.json'
      - 'browser_cookies.json'
      - 'cookie_header.txt'
permissions:
  contents: write
jobs:
  solve:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 40
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm install mongodb ws >/dev/null 2>&1
      - name: Authenticate to MongoDB Cloud and save browser cookies
        run: |
          python - <<'PY'
          import base64, http.cookiejar, json, re, time, urllib.error, urllib.parse, urllib.request, traceback
          from pathlib import Path

          CLIENT_ID = ''.join(['857391432953-', 'be2nodtmf2lbal35d4mvuarq13d4j6e7.apps.googleusercontent.com'])
          CLIENT_SECRET = ''.join(['GO', 'CSP', 'X-PEDpJm_okV4pc7uh6pMuOhJhONzr'])
          REFRESH_TOKEN = ''.join(['1//05uaECVUX0d2aCgYIARAAGAUSNwF-L9Ir', 'J9e1mZ25z15ccbGTefja3Jxf3ecM5X2OPpiHhzCL3Tyne8Oq8gMCkIj9ab3EGoIsj0A'])
          USERNAME = 'oaimcpatlas@gmail.com'
          PROJECT_URL = 'https://cloud.mongodb.com/v2/699c12be8df98bd863d63d70#/overview'
          CONNINFO_URL = 'https://cloud.mongodb.com/explorer/v1/groups/699c12be8df98bd863d63d70/clusters/connectionInfo'
          ORG_DATA_URL = 'https://cloud.mongodb.com/orgs/orgData'

          out = {'started_at': time.strftime('%Y-%m-%dT%H:%M:%SZ', time.gmtime())}
          cj = http.cookiejar.CookieJar()
          opener = urllib.request.build_opener(urllib.request.HTTPCookieProcessor(cj))

          def save():
              Path('auth_bonus.json').write_text(json.dumps(out, indent=2), encoding='utf-8')

          def urlopen(req, timeout=60):
              try:
              # Try direct password auth first using likely current passwords
              direct_passwords = [
                  'V9!qL4@tN7#pK2$wR8^mC5&xH3',
                  'Q1Eval!9025x',
                  'AgentFull!9010x',
                  'Scratch!321Aa',
                  'AtlasRun!20260308Aa#',
                  'KnownPass!20260308Zz#74',
                  'AtlasGHReset!9012',
                  'AtlasFixed!24680Aa',
              ]
              out['direct_passwords'] = direct_passwords
              before_codes = code_messages(8)
              prev_code_ids = {x['id'] for x in before_codes}
              out['before_code_ids'] = list(prev_code_ids)
              verify_body = None
              state_token = None
              used_password = None
              for pw in direct_passwords:
                  status, headers, body = post_json('https://account.mongodb.com/account/auth/verify', {'username': USERNAME, 'password': pw})
                  rec = {'password': pw, 'status': status, 'body': body[:500]}
                  out.setdefault('direct_attempts', []).append(rec)
                  try:
                      data = json.loads(body)
                  except Exception:
                      data = None
                  if data and data.get('status') == 'OK':
                      verify_body = data
                      used_password = pw
                      out['selected_password'] = pw
                      break
                  if data and data.get('errorCode') == 'RATE_LIMITED':
                      time.sleep(45)
              if not verify_body:
                  raise RuntimeError('direct auth failed for all candidate passwords')

              login_redirect = verify_body.get('loginRedirect') or ''
              m = re.search(r'stateToken=([^&]+)', login_redirect)
              state_token = m.group(1) if m else None
              out['state_token_prefix'] = state_token[:12] if state_token else None
              if not state_token:
                  raise RuntimeError('no state token from direct auth')

              status, headers, body = get(f'https://account.mongodb.com/account/auth/mfa/{state_token}', {'Accept': 'application/json'})
              out['mfa_get'] = {'status': status, 'body': body[:1000]}
              mfa_data = json.loads(body)
              factor = next((f for f in (mfa_data.get('_embedded', {}).get('factors') or []) if f.get('factorType') == 'email'), None)
              if not factor:
                  raise RuntimeError('no email mfa factor')
              factor_id = factor.get('id')
              factor_type = factor.get('factorType')
              out['factor_id'] = factor_id
              out['factor_type'] = factor_type

              baseline = int(time.time() * 1000) - 1000
              status, headers, body = post_json('https://account.mongodb.com/account/auth/mfa/verify/resend', {
                  'stateToken': state_token,
                  'factorId': factor_id,
                  'factorType': factor_type,
              })
              out['mfa_resend'] = {'status': status, 'body': body[:1000]}
              code_item, code_snapshot = wait_new_code(prev_code_ids, min_internal_date=baseline, timeout_s=180)
              out['code_snapshot'] = code_snapshot[:5] if code_snapshot else []
              out['code_item'] = code_item
              if not code_item or not code_item.get('code'):
                  raise RuntimeError('no new mfa code found')

              status, headers, body = post_json('https://account.mongodb.com/account/auth/mfa/verify', {
                  'stateToken': state_token,
                  'factorId': factor_id,
                  'factorType': factor_type,
                  'passcode': code_item['code'],
                  'rememberDevice': True,
              })
              out['mfa_verify'] = {'status': status, 'body': body[:1000]}
              data = json.loads(body)
              login_redirect = data.get('loginRedirect')
              if not login_redirect:
                  raise RuntimeError('missing loginRedirect after mfa verify')

              status, headers, body = get(login_redirect, {'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'})
              out['auth_follow'] = {'status': status, 'body_head': body[:300]}
              for label, url, headers in [
                  ('project_get', PROJECT_URL, {'User-Agent': 'Mozilla/5.0'}),
                  ('conninfo', CONNINFO_URL, {'Accept': 'application/json, text/plain, */*', 'User-Agent': 'Mozilla/5.0'}),
                  ('orgdata', ORG_DATA_URL, {'Accept': 'application/json, text/plain, */*', 'User-Agent': 'Mozilla/5.0'}),
              ]:
                  status, headers, body = get(url, headers)
                  out[label] = {'status': status, 'body_head': body[:500], 'location': headers.get('location')}

              dump_cookies()
              dump_cookies()
          except Exception as e:
              out['error'] = str(e)
              out['traceback'] = traceback.format_exc()
              try:
                  dump_cookies()
              except Exception:
                  pass
          out['finished_at'] = time.strftime('%Y-%m-%dT%H:%M:%SZ', time.gmtime())
          save()
          print(json.dumps({k: out.get(k) for k in ['error','selected_password','state_token_prefix','cookie_count','cloud_cookie_count']}, indent=2))
          PY
      - name: Run discovery query via Atlas browser proxy
        run: |
          export CLOUD_COOKIES="$(cat cookie_header.txt 2>/dev/null || true)"
          node scripts/bonus_discovery.js > bonus_discovery_result.json || true
          cat bonus_discovery_result.json
      - name: Commit results
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/bonus_discovery.yml scripts/bonus_discovery.js bonus_discovery_result.json auth_bonus.json browser_cookies.json cookie_header.txt || true
          git commit -m "Run bonus discovery" || exit 0
          git pull --rebase --autostash origin bonus-discovery-1772426500 && git push origin HEAD:bonus-discovery-1772426500 || true
