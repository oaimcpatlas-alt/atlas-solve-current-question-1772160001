name: ResetPassword
on:
  push:
    branches: [main]
    paths:
      - '.github/workflows/reset_pass.yml'
permissions:
  contents: write
jobs:
  reset:
    if: github.actor != 'github-actions[bot]'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Install requests
        run: pip install requests
      - name: Run reset
        run: |
          python - <<'PY'
          import requests, json
          reset_link = 'https://account.mongodb.com/account/reset/password/190e0d6566bf457a2d33ff7c119eaa8531412dbd7e04a6f5172ed5c5cf92d1a9?email=oaimcpatlas%40gmail.com'
          temp_id = '190e0d6566bf457a2d33ff7c119eaa8531412dbd7e04a6f5172ed5c5cf92d1a9'
          password = 'AtlasKnown!12345'
          s = requests.Session()
          first = s.get(reset_link, timeout=30)
          payload = {
              "username": "oaimcpatlas@gmail.com",
              "password": password,
              "passwordConfirm": password,
              "tempId": temp_id,
              "isPendingUser": False
          }
          r = s.post("https://account.mongodb.com/account/resetPasswordComplete",
                     headers={"Content-Type": "application/json"},
                     data=json.dumps(payload), timeout=30)
          out = {
              "get_status": first.status_code,
              "status": r.status_code,
              "text": r.text[:2000],
              "headers": dict(r.headers),
          }
          try:
              vr = s.post("https://account.mongodb.com/account/auth/verify",
                          headers={"Content-Type": "application/json"},
                          data=json.dumps({"username": "oaimcpatlas@gmail.com", "password": password}), timeout=30)
              out["verify_status"] = vr.status_code
              out["verify_text"] = vr.text[:2000]
              out["verify_headers"] = dict(vr.headers)
          except Exception as e:
              out["verify_error"] = str(e)
          with open("reset_result.json", "w", encoding="utf-8") as f:
              json.dump(out, f, indent=2)
          print(json.dumps(out))
          PY
      - name: Commit result
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add reset_result.json
          git commit -m "Write reset result" || exit 0
          for i in 1 2 3 4 5; do
            git pull --rebase origin main && git push && exit 0 || true
            sleep 10
          done
          exit 1
